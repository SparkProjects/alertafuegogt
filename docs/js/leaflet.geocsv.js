/*
* Copyright 2013 - GPL
* Iv√°n Eixarch <ivan@sinanimodelucro.org>
* https://github.com/joker-x/Leaflet.geoCSV
*/
L.GeoCSV=L.GeoJSON.extend({options:{titles:["lat","lng","popup"],fieldSeparator:";",lineSeparator:"\n",deleteDobleQuotes:!0,firstLineTitles:!1},_propertiesNames:[],initialize:function(e,t){L.Util.setOptions(this,t),L.GeoJSON.prototype.initialize.call(this,e,t)},addData:function(e){if("string"==typeof e){var t=this.options.titles;if(this.options.firstLineTitles){if(e=e.split(this.options.lineSeparator),e.length<2)return;t=e[0],e.splice(0,1),e=e.join(this.options.lineSeparator),t=t.trim().split(this.options.fieldSeparator);for(var i=0;i<t.length;i++)t[i]=this._deleteDobleQuotes(t[i]);this.options.titles=t}for(var i=0;i<t.length;i++){var o=t[i].toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"_");(""==o||"_"==o||this._propertiesNames.indexOf(o)>=0)&&(o="prop-"+i),this._propertiesNames[i]=o}e=this._csv2json(e)}L.GeoJSON.prototype.addData.call(this,e)},getPropertyName:function(e){var t=this.options.titles.indexOf(e),i="";return t>=0&&(i=this._propertiesNames[t]),i},getPropertyTitle:function(e){var t=this._propertiesNames.indexOf(e),i="";return t>=0&&(i=this.options.titles[t]),i},_deleteDobleQuotes:function(e){return this.options.deleteDobleQuotes&&(e=e.trim().replace(/^"/,"").replace(/"$/,"")),e},_csv2json:function(e){var t={};t.type="FeatureCollection",t.features=[];var i=this.options.titles;e=e.split(this.options.lineSeparator);for(var o=0;o<e.length;o++){var r=e[o].trim().split(this.options.fieldSeparator),s=parseFloat(r[i.indexOf("lng")]),n=parseFloat(r[i.indexOf("lat")]);if(r.length==i.length&&s<180&&s>-180&&n<90&&n>-90){var p={};p.type="Feature",p.geometry={},p.properties={},p.geometry.type="Point",p.geometry.coordinates=[s,n];for(var a=0;a<i.length;a++)"lat"!=i[a]&&"lng"!=i[a]&&(p.properties[this._propertiesNames[a]]=this._deleteDobleQuotes(r[a]));t.features.push(p)}}return t}}),L.geoCsv=function(e,t){return new L.GeoCSV(e,t)};