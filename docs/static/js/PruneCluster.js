var PruneCluster,__extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])};return function(t,e){function r(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}}();!function(t){function c(t,e){return t.lat>=e.minLat&&t.lat<=e.maxLat&&t.lng>=e.minLng&&t.lng<=e.maxLng}function r(t){for(var e,r,n,a=1,o=t.length;a<o;++a){for(n=(r=t[a]).position.lng,e=a-1;0<=e&&t[e].position.lng>n;--e)t[e+1]=t[e];t[e+1]=r}}function n(t,e){return!(300<e)&&e/t<.2}var e=function(){function t(){}return t}();t.Point=e;var a=function(){function t(){}return t}();t.ClusterObject=a;var l=1,i=Math.pow(2,53)-1,o=function(s){function t(t,e,r,n,a,o){void 0===r&&(r={}),void 0===a&&(a=1),void 0===o&&(o=!1);var i=s.call(this)||this;return i.data=r,i.position={lat:+t,lng:+e},i.weight=a,i.category=n,i.filtered=o,i.hashCode=l++,i}return __extends(t,s),t.prototype.Move=function(t,e){this.position.lat=+t,this.position.lng=+e},t.prototype.SetData=function(t){for(var e in t)this.data[e]=t[e]},t}(a);t.Marker=o;var L=function(r){function o(t){var e=r.call(this)||this;return e.stats=[0,0,0,0,0,0,0,0],e.data={},t?(o.ENABLE_MARKERS_LIST&&(e._clusterMarkers=[t]),e.lastMarker=t,e.hashCode=31+t.hashCode,e.population=1,t.category!==undefined&&(e.stats[t.category]=1),e.totalWeight=t.weight,e.position={lat:t.position.lat,lng:t.position.lng},e.averagePosition={lat:t.position.lat,lng:t.position.lng}):(e.hashCode=1,o.ENABLE_MARKERS_LIST&&(e._clusterMarkers=[])),e}return __extends(o,r),o.prototype.AddMarker=function(t){o.ENABLE_MARKERS_LIST&&this._clusterMarkers.push(t);var e=this.hashCode;e=(e<<5)-e+t.hashCode,this.hashCode=i<=e?e%i:e;var r=(this.lastMarker=t).weight,n=this.totalWeight,a=r+n;this.averagePosition.lat=(this.averagePosition.lat*n+t.position.lat*r)/a,this.averagePosition.lng=(this.averagePosition.lng*n+t.position.lng*r)/a,++this.population,this.totalWeight=a,t.category!==undefined&&(this.stats[t.category]=this.stats[t.category]+1||1)},o.prototype.Reset=function(){this.hashCode=1,this.lastMarker=undefined,this.population=0,this.totalWeight=0,this.stats=[0,0,0,0,0,0,0,0],o.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[])},o.prototype.ComputeBounds=function(t){var e=t.Project(this.position.lat,this.position.lng),r=t.Size,n=Math.floor(e.x/r)*r,a=Math.floor(e.y/r)*r,o=t.UnProject(n,a),i=t.UnProject(n+r,a+r);this.bounds={minLat:i.lat,maxLat:o.lat,minLng:o.lng,maxLng:i.lng}},o.prototype.GetClusterMarkers=function(){return this._clusterMarkers},o.prototype.ApplyCluster=function(t){this.hashCode=41*this.hashCode+43*t.hashCode,this.hashCode>i&&(this.hashCode=this.hashCode=i);var e=t.totalWeight,r=this.totalWeight,n=e+r;for(var a in this.averagePosition.lat=(this.averagePosition.lat*r+t.averagePosition.lat*e)/n,this.averagePosition.lng=(this.averagePosition.lng*r+t.averagePosition.lng*e)/n,this.population+=t.population,this.totalWeight=n,this.bounds.minLat=Math.min(this.bounds.minLat,t.bounds.minLat),this.bounds.minLng=Math.min(this.bounds.minLng,t.bounds.minLng),this.bounds.maxLat=Math.max(this.bounds.maxLat,t.bounds.maxLat),this.bounds.maxLng=Math.max(this.bounds.maxLng,t.bounds.maxLng),t.stats)t.stats.hasOwnProperty(a)&&(this.stats.hasOwnProperty(a)?this.stats[a]+=t.stats[a]:this.stats[a]=t.stats[a]);o.ENABLE_MARKERS_LIST&&(this._clusterMarkers=this._clusterMarkers.concat(t.GetClusterMarkers()))},o.ENABLE_MARKERS_LIST=!1,o}(a);t.Cluster=L;var s=function(){function t(){this._markers=[],this._nbChanges=0,this._clusters=[],this.Size=166,this.ViewPadding=.2}return t.prototype.RegisterMarker=function(t){t._removeFlag&&delete t._removeFlag,this._markers.push(t),this._nbChanges+=1},t.prototype.RegisterMarkers=function(t){var e=this;t.forEach(function(t){e.RegisterMarker(t)})},t.prototype._sortMarkers=function(){var t=this._markers,e=t.length;this._nbChanges&&!n(e,this._nbChanges)?this._markers.sort(function(t,e){return t.position.lng-e.position.lng}):r(t),this._nbChanges=0},t.prototype._sortClusters=function(){r(this._clusters)},t.prototype._indexLowerBoundLng=function(t){for(var e,r,n=this._markers,a=0,o=n.length;0<o;)n[e=a+(r=Math.floor(o/2))].position.lng<t?(a=++e,o-=r+1):o=r;return a},t.prototype._resetClusterViews=function(){for(var t=0,e=this._clusters.length;t<e;++t){var r=this._clusters[t];r.Reset(),r.ComputeBounds(this)}},t.prototype.ProcessView=function(t){var e=Math.abs(t.maxLat-t.minLat)*this.ViewPadding,r=Math.abs(t.maxLng-t.minLng)*this.ViewPadding,n={minLat:t.minLat-e-e,maxLat:t.maxLat+e+e,minLng:t.minLng-r-r,maxLng:t.maxLng+r+r};this._sortMarkers(),this._resetClusterViews();for(var a=this._indexLowerBoundLng(n.minLng),o=this._markers,i=this._clusters,s=i.slice(0),l=a,h=o.length;l<h;++l){var u=o[l],p=u.position;if(p.lng>n.maxLng)break;if(p.lat>n.minLat&&p.lat<n.maxLat&&!u.filtered){for(var f,d=!1,m=0,_=s.length;m<_;++m)if((f=s[m]).bounds.maxLng<u.position.lng)s.splice(m,1),--m,--_;else if(c(p,f.bounds)){f.AddMarker(u),d=!0;break}d||((f=new L(u)).ComputeBounds(this),i.push(f),s.push(f))}}var g=[];for(l=0,h=i.length;l<h;++l)0<(f=i[l]).population&&g.push(f);return this._clusters=g,this._sortClusters(),this._clusters},t.prototype.RemoveMarkers=function(t){if(t){for(var e=0,r=t.length;e<r;++e)t[e]._removeFlag=!0;var n=[];for(e=0,r=this._markers.length;e<r;++e)this._markers[e]._removeFlag?delete this._markers[e]._removeFlag:n.push(this._markers[e]);this._markers=n}else this._markers=[]},t.prototype.FindMarkersInArea=function(t){for(var e=t.minLat,r=t.maxLat,n=t.minLng,a=t.maxLng,o=this._markers,i=[],s=this._indexLowerBoundLng(n),l=o.length;s<l;++s){var h=o[s].position;if(h.lng>a)break;h.lat>=e&&h.lat<=r&&h.lng>=n&&i.push(o[s])}return i},t.prototype.ComputeBounds=function(t,e){if(void 0===e&&(e=!0),!t||!t.length)return null;for(var r=Number.MAX_VALUE,n=-Number.MAX_VALUE,a=Number.MAX_VALUE,o=-Number.MAX_VALUE,i=0,s=t.length;i<s;++i)if(e||!t[i].filtered){var l=t[i].position;l.lat<r&&(r=l.lat),l.lat>n&&(n=l.lat),l.lng<a&&(a=l.lng),l.lng>o&&(o=l.lng)}return{minLat:r,maxLat:n,minLng:a,maxLng:o}},t.prototype.FindMarkersBoundsInArea=function(t){return this.ComputeBounds(this.FindMarkersInArea(t))},t.prototype.ComputeGlobalBounds=function(t){return void 0===t&&(t=!0),this.ComputeBounds(this._markers,t)},t.prototype.GetMarkers=function(){return this._markers},t.prototype.GetPopulation=function(){return this._markers.length},t.prototype.ResetClusters=function(){this._clusters=[]},t}();t.PruneCluster=s}(PruneCluster||(PruneCluster={})),PruneCluster||(PruneCluster={});var PruneClusterForLeaflet=(L.Layer?L.Layer:L.Class).extend({initialize:function(t,e){var r=this;void 0===t&&(t=120),void 0===e&&(e=20),this.Cluster=new PruneCluster.PruneCluster,this.Cluster.Size=t,this.clusterMargin=Math.min(e,t/4),this.Cluster.Project=function(t,e){return r._map.project(new L.LatLng(t,e),Math.floor(r._map.getZoom()))},this.Cluster.UnProject=function(t,e){return r._map.unproject(new L.Point(t,e),Math.floor(r._map.getZoom()))},this._objectsOnMap=[],this.spiderfier=new PruneClusterLeafletSpiderfier(this),this._hardMove=!1,this._resetIcons=!1,this._removeTimeoutId=0,this._markersRemoveListTimeout=[]},RegisterMarker:function(t){this.Cluster.RegisterMarker(t)},RegisterMarkers:function(t){this.Cluster.RegisterMarkers(t)},RemoveMarkers:function(t){this.Cluster.RemoveMarkers(t)},BuildLeafletCluster:function(t,e){var g=this,c=new L.Marker(e,{icon:this.BuildLeafletClusterIcon(t)});return c._leafletClusterBounds=t.bounds,c.on("click",function(){var t=c._leafletClusterBounds,e=g.Cluster.FindMarkersInArea(t),r=g.Cluster.ComputeBounds(e);if(r){var n=new L.LatLngBounds(new L.LatLng(r.minLat,r.maxLng),new L.LatLng(r.maxLat,r.minLng)),a=g._map.getZoom(),o=g._map.getBoundsZoom(n,!1,new L.Point(20,20));if(o===a){for(var i=[],s=0,l=g._objectsOnMap.length;s<l;++s){var h=g._objectsOnMap[s];h.data._leafletMarker!==c&&h.bounds.minLat>=t.minLat&&h.bounds.maxLat<=t.maxLat&&h.bounds.minLng>=t.minLng&&h.bounds.maxLng<=t.maxLng&&i.push(h.bounds)}if(0<i.length){var u=[],p=i.length;for(s=0,l=e.length;s<l;++s){for(var f=e[s].position,d=!1,m=0;m<p;++m){var _=i[m];if(f.lat>=_.minLat&&f.lat<=_.maxLat&&f.lng>=_.minLng&&f.lng<=_.maxLng){d=!0;break}}d||u.push(e[s])}e=u}e.length<200||o>=g._map.getMaxZoom()?g._map.fire("overlappingmarkers",{cluster:g,markers:e,center:c.getLatLng(),marker:c}):o++,g._map.setView(c.getLatLng(),o)}else g._map.fitBounds(n)}}),c},BuildLeafletClusterIcon:function(t){var e="prunecluster prunecluster-",r=38,n=this.Cluster.GetPopulation();return t.population<Math.max(10,.01*n)?e+="small":t.population<Math.max(100,.05*n)?(e+="medium",r=40):(e+="large",r=44),new L.DivIcon({html:"<div><span>"+t.population+"</span></div>",className:e,iconSize:L.point(r,r)})},BuildLeafletMarker:function(t,e){var r=new L.Marker(e);return this.PrepareLeafletMarker(r,t.data,t.category),r},PrepareLeafletMarker:function(t,e,r){if(e.icon&&("function"==typeof e.icon?t.setIcon(e.icon(e,r)):t.setIcon(e.icon)),e.popup){var n="function"==typeof e.popup?e.popup(e,r):e.popup;t.getPopup()?t.setPopupContent(n,e.popupOptions):t.bindPopup(n,e.popupOptions)}},onAdd:function(t){(this._map=t).on("movestart",this._moveStart,this),t.on("moveend",this._moveEnd,this),t.on("zoomend",this._zoomStart,this),t.on("zoomend",this._zoomEnd,this),this.ProcessView(),t.addLayer(this.spiderfier)},onRemove:function(t){t.off("movestart",this._moveStart,this),t.off("moveend",this._moveEnd,this),t.off("zoomend",this._zoomStart,this),t.off("zoomend",this._zoomEnd,this);for(var e=0,r=this._objectsOnMap.length;e<r;++e)t.removeLayer(this._objectsOnMap[e].data._leafletMarker);this._objectsOnMap=[],this.Cluster.ResetClusters(),t.removeLayer(this.spiderfier),this._map=null},_moveStart:function(){this._moveInProgress=!0},_moveEnd:function(t){this._moveInProgress=!1,this._hardMove=t.hard,this.ProcessView()},_zoomStart:function(){this._zoomInProgress=!0},_zoomEnd:function(){this._zoomInProgress=!1,this.ProcessView()},ProcessView:function(){var i=this;if(this._map&&!this._zoomInProgress&&!this._moveInProgress){for(var t=this._map,e=t.getBounds(),s=Math.floor(t.getZoom()),r=this.clusterMargin/this.Cluster.Size,l=this._resetIcons,n=e.getSouthWest(),a=e.getNorthEast(),o=this.Cluster.ProcessView({minLat:n.lat,minLng:n.lng,maxLat:a.lat,maxLng:a.lng}),h=this._objectsOnMap,u=[],p=new Array(h.length),f=0,d=h.length;f<d;++f){var m=h[f].data._leafletMarker;(p[f]=m)._removeFromMap=!0}var _=[],g=[],c=[],v=[];for(f=0,d=o.length;f<d;++f){for(var M=o[f],k=M.data,C=(M.bounds.maxLat-M.bounds.minLat)*r,P=(M.bounds.maxLng-M.bounds.minLng)*r,y=0,w=v.length;y<w;++y){var b=v[y];if(b.bounds.maxLng<M.bounds.minLng)v.splice(y,1),--y,--w;else{var x=b.averagePosition.lng+P,I=b.averagePosition.lat-C,S=b.averagePosition.lat+C,B=M.averagePosition.lng-P,R=M.averagePosition.lat-C,O=M.averagePosition.lat+C;if(B<x&&R<S&&I<O){k._leafletCollision=!0,b.ApplyCluster(M);break}}}k._leafletCollision||v.push(M)}for(o.forEach(function(t){var e=undefined,r=t.data;if(r._leafletCollision)return r._leafletCollision=!1,r._leafletOldPopulation=0,void(r._leafletOldHashCode=0);var n=new L.LatLng(t.averagePosition.lat,t.averagePosition.lng),a=r._leafletMarker;if(a)if(1===t.population&&1===r._leafletOldPopulation&&t.hashCode===a._hashCode)(l||a._zoomLevel!==s||t.lastMarker.data.forceIconRedraw)&&(i.PrepareLeafletMarker(a,t.lastMarker.data,t.lastMarker.category),t.lastMarker.data.forceIconRedraw&&(t.lastMarker.data.forceIconRedraw=!1)),a.setLatLng(n),e=a;else if(1<t.population&&1<r._leafletOldPopulation&&(a._zoomLevel===s||r._leafletPosition.equals(n))){if(a.setLatLng(n),l||t.population!=r._leafletOldPopulation||t.hashCode!==r._leafletOldHashCode){var o={};L.Util.extend(o,t.bounds),a._leafletClusterBounds=o,a.setIcon(i.BuildLeafletClusterIcon(t))}r._leafletOldPopulation=t.population,r._leafletOldHashCode=t.hashCode,e=a}e?(e._removeFromMap=!1,u.push(t),e._zoomLevel=s,e._hashCode=t.hashCode,e._population=t.population,r._leafletMarker=e,r._leafletPosition=n):(1===t.population?g.push(t):_.push(t),r._leafletPosition=n,r._leafletOldPopulation=t.population,r._leafletOldHashCode=t.hashCode)}),_=g.concat(_),f=0,d=h.length;f<d;++f){var A=(M=h[f]).data;if(m=A._leafletMarker,A._leafletMarker._removeFromMap){var E=!0;if(m._zoomLevel===s){var z=M.averagePosition;for(C=(M.bounds.maxLat-M.bounds.minLat)*r,P=(M.bounds.maxLng-M.bounds.minLng)*r,y=0,w=_.length;y<w;++y){var T=_[y],F=T.data;if(1===m._population&&1===T.population&&m._hashCode===T.hashCode)(l||T.lastMarker.data.forceIconRedraw)&&(this.PrepareLeafletMarker(m,T.lastMarker.data,T.lastMarker.category),T.lastMarker.data.forceIconRedraw&&(T.lastMarker.data.forceIconRedraw=!1)),m.setLatLng(F._leafletPosition),E=!1;else{var j=T.averagePosition,U=z.lng-P,V=j.lng+P;if(x=z.lng+P,I=z.lat-C,S=z.lat+C,B=j.lng-P,R=j.lat-C,O=j.lat+C,1<m._population&&1<T.population&&B<x&&U<V&&R<S&&I<O){m.setLatLng(F._leafletPosition),m.setIcon(this.BuildLeafletClusterIcon(T));var N={};L.Util.extend(N,T.bounds),m._leafletClusterBounds=N,F._leafletOldPopulation=T.population,F._leafletOldHashCode=T.hashCode,m._population=T.population,E=!1}}if(!E){(F._leafletMarker=m)._removeFromMap=!1,u.push(T),_.splice(y,1),--y,--w;break}}}E&&(m._removeFromMap||console.error("wtf"))}}for(f=0,d=_.length;f<d;++f){var D,G=(A=(M=_[f]).data)._leafletPosition;(D=1===M.population?this.BuildLeafletMarker(M.lastMarker,G):this.BuildLeafletCluster(M,G)).addTo(t),D.setOpacity(0),c.push(D),(A._leafletMarker=D)._zoomLevel=s,D._hashCode=M.hashCode,D._population=M.population,u.push(M)}if(window.setTimeout(function(){for(f=0,d=c.length;f<d;++f){var t=c[f];t._icon&&L.DomUtil.addClass(t._icon,"prunecluster-anim"),t._shadow&&L.DomUtil.addClass(t._shadow,"prunecluster-anim"),t.setOpacity(1)}},1),this._hardMove)for(f=0,d=p.length;f<d;++f)(m=p[f])._removeFromMap&&t.removeLayer(m);else{if(0!==this._removeTimeoutId)for(window.clearTimeout(this._removeTimeoutId),f=0,d=this._markersRemoveListTimeout.length;f<d;++f)t.removeLayer(this._markersRemoveListTimeout[f]);var W=[];for(f=0,d=p.length;f<d;++f)(m=p[f])._removeFromMap&&(m.setOpacity(0),W.push(m));0<W.length&&(this._removeTimeoutId=window.setTimeout(function(){for(f=0,d=W.length;f<d;++f)t.removeLayer(W[f]);i._removeTimeoutId=0},300)),this._markersRemoveListTimeout=W}this._objectsOnMap=u,this._hardMove=!1,this._resetIcons=!1}},FitBounds:function(t){void 0===t&&(t=!0);var e=this.Cluster.ComputeGlobalBounds(t);e&&this._map.fitBounds(new L.LatLngBounds(new L.LatLng(e.minLat,e.maxLng),new L.LatLng(e.maxLat,e.minLng)))},GetMarkers:function(){return this.Cluster.GetMarkers()},RedrawIcons:function(t){void 0===t&&(t=!0),this._resetIcons=!0,t&&this.ProcessView()}}),PruneClusterLeafletSpiderfier=(L.Layer?L.Layer:L.Class).extend({_2PI:2*Math.PI,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_spiralCountTrigger:8,spiderfyDistanceMultiplier:1,initialize:function(t){this._cluster=t,this._currentMarkers=[],this._multiLines=!!L.multiPolyline,this._lines=this._multiLines?L.multiPolyline([],{weight:1.5,color:"#222"}):L.polyline([],{weight:1.5,color:"#222"})},onAdd:function(t){this._map=t,this._map.on("overlappingmarkers",this.Spiderfy,this),this._map.on("click",this.Unspiderfy,this),this._map.on("zoomend",this.Unspiderfy,this)},Spiderfy:function(h){var u=this;if(h.cluster===this._cluster){this.Unspiderfy();var t=h.markers.filter(function(t){return!t.filtered});this._currentCenter=h.center;var p,e=this._map.latLngToLayerPoint(h.center);t.length>=this._spiralCountTrigger?p=this._generatePointsSpiral(t.length,e):(this._multiLines&&(e.y+=10),p=this._generatePointsCircle(t.length,e));for(var f=[],r=[],d=[],m=0,_=p.length;m<_;++m){var n=this._map.layerPointToLatLng(p[m]),a=this._cluster.BuildLeafletMarker(t[m],h.center);a.setZIndexOffset(5e3),a.setOpacity(0),this._currentMarkers.push(a),this._map.addLayer(a),r.push(a),d.push(n)}window.setTimeout(function(){for(m=0,_=p.length;m<_;++m)r[m].setLatLng(d[m]).setOpacity(1);var i=+new Date,t=42,s=290,l=window.setInterval(function(){f=[];var t=+new Date-i;if(s<=t)window.clearInterval(l),e=1;else var e=t/s;var r=h.center;for(m=0,_=p.length;m<_;++m){var n=d[m],a=n.lat-r.lat,o=n.lng-r.lng;f.push([r,new L.LatLng(r.lat+a*e,r.lng+o*e)])}u._lines.setLatLngs(f)},t)},1),this._lines.setLatLngs(f),this._map.addLayer(this._lines),h.marker&&(this._clusterMarker=h.marker.setOpacity(.3))}},_generatePointsCircle:function(t,e){var r,n,a=this.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+t)/this._2PI,o=this._2PI/t,i=[];for(r=(i.length=t)-1;0<=r;r--)n=this._circleStartAngle+r*o,i[r]=new L.Point(Math.round(e.x+a*Math.cos(n)),Math.round(e.y+a*Math.sin(n)));return i},_generatePointsSpiral:function(t,e){var r,n=this.spiderfyDistanceMultiplier*this._spiralLengthStart,a=this.spiderfyDistanceMultiplier*this._spiralFootSeparation,o=this.spiderfyDistanceMultiplier*this._spiralLengthFactor,i=0,s=[];for(r=(s.length=t)-1;0<=r;r--)i+=a/n+5e-4*r,s[r]=new L.Point(Math.round(e.x+n*Math.cos(i)),Math.round(e.y+n*Math.sin(i))),n+=this._2PI*o/i;return s},Unspiderfy:function(){for(var t=this,e=0,r=this._currentMarkers.length;e<r;++e)this._currentMarkers[e].setLatLng(this._currentCenter).setOpacity(0);var n=this._currentMarkers;window.setTimeout(function(){for(e=0,r=n.length;e<r;++e)t._map.removeLayer(n[e])},300),this._currentMarkers=[],this._map.removeLayer(this._lines),this._clusterMarker&&this._clusterMarker.setOpacity(1)},onRemove:function(t){this.Unspiderfy(),t.off("overlappingmarkers",this.Spiderfy,this),t.off("click",this.Unspiderfy,this),t.off("zoomend",this.Unspiderfy,this)}});